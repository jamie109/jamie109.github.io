---
layout: post
title: CPU是如何执行程序的
date: 2023-09-22 10:34 +0800
categories: [CS_course, OS]
tags: [OS]
mermaid: true
math: true
---

## 1、图灵机

- 基本思想：用机器来模拟人们用纸笔进行数学运算的过程。
- 存储单元、控制单元以及运算单元：存储单元用于存放数据；控制单元用于识别字符是数据还是指令，以及控制程序的流程等；运算单元用于执行运算指令。
  
## 2、冯诺依曼模型

定义计算机基本结构为 5 个部分：运算器、控制器、存储器、输入设备、输出设备。**运算器、控制器是在中央处理器里的**，存储器就我们常见的内存，输入输出设备则是计算机外接的设备。**存储单元和输入输出设备要与中央处理器打交道的话，离不开总线。**

![20230922103820](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230922103820.png)


### 内存

程序和数据都是存储在内存，存储的区域是**线性**的。

在计算机数据存储中，**存储数据的基本单位是字节**，每一个字节都对应一个内存地址。**内存地址从 0 开始编号，然后自增排列**，最后一个地址为内存总字节数 - 1，这种结构类似数组，所以内存的读写任何一个数据的速度都是一样的。

### 中央处理器

32 位和 64 位 CPU 最主要区别在于**一次能计算多少字节数据**：32 位 CPU 一次可以计算 4 个字节；64 位 CPU 一次可以计算 8 个字节。（这里的 32 位和 64 位，通常称为 **CPU 的位宽**，代表的是 CPU 一次可以计算/运算的数据量）

CPU 内部还有一些组件，常见的有寄存器、控制单元和逻辑运算单元等。其中，控制单元负责控制 CPU 工作，逻辑运算单元负责计算，寄存器存储计算时的数据。

### 总线

总线**用于 CPU 和内存以及其他设备之间的通信**，可分为 3 种：
- 地址总线，用于指定 CPU 将要操作的内存地址；
- 数据总线，用于读写内存的数据；
- 控制总线，用于发送和接收信号，比如中断、设备复位等信号，CPU 收到信号后自然进行响应，这时也需要控制总线。
  
  **想要 CPU 操作 4G 大的内存，那么就需要 32 条地址总线**，因为 $2^{32} = 4G$。

  - CPU 的位宽最好不要小于线路位宽。
  - 如果计算的数额不超过 32 位数字的情况下，32 位和 64 位 CPU 之间没什么区别的，只有当计算超过 32 位数字的情况下，64 位的优势才能体现出来。

## 3、程序执行的基本过程

程序实际上是一条一条指令，所以程序的运行过程就是把每一条指令一步一步的执行起来，负责执行指令的是 CPU 。一个程序执行的时候，CPU 会根据程序计数器里的**内存地址**，从内存里面把需要执行的指令读取到指令寄存器里面执行，然后**根据指令长度自增**（ CPU 位宽32，指令占 32 位），开始顺序读取下一条指令。

CPU 从程序计数器读取指令、到执行、再到下一条指令，这个过程会不断循环，直到程序执行结束，这个不断循环的过程被称为 CPU 的指令周期。

## 4、指令

指令的内容是一串二进制数字的机器码，每条指令都有对应的**机器码**，CPU 通过解析机器码来知道指令的内容。

MIPS 的指令是一个 32 位的整数，**高 6 位代表着操作码，表示这条指令是一条什么样的指令**，剩下的 26 位不同指令类型所表示的内容也就不相同，主要有三种类型R、I 和 J。

![20230922105914](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230922105914.png)

- R 指令
  
  用在**算术和逻辑**操作，里面有读取和写入数据的寄存器地址。如果是逻辑位移操作，后面还有位移操作的「位移量」，而最后的「功能码」则是再前面的操作码不够的时候，扩展操作码来表示对应的具体指令的；

- I 指令
  
  **用在数据传输、条件分支等**。这个类型的指令，就没有了位移量和功能码，也没有了第三个寄存器，而是把这三部分直接合并成了一个地址值或一个常数；

- J 指令
  
  **用在跳转**，高 6 位之外的 26 位都是一个跳转后的地址。

现代大多数 CPU 都使用来流水线的方式来执行指令，流水线就是把一个任务拆分成多个小任务，一条指令通常分为 4 个阶段（指令周期），称为 4 级流水线。
1. CPU 通过程序计数器读取对应内存地址的指令，这个部分称为 Fetch（取得指令）；
2. CPU 对指令进行解码，这个部分称为 Decode（指令译码）；
3. CPU 执行指令，这个部分称为 Execution（执行指令）；
4. CPU 将计算结果存回寄存器或者将寄存器的值存入内存，这个部分称为 Store（数据回写）。
   
   ![20230922111047](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230922111047.png)

取指、译码在控制器中进行，如果只是无条件地址跳转指令，也在控制器中进行。

对于 CPU 来说，**在一个时钟周期内，CPU 仅能完成一个最基本的动作**，时钟频率越高，时钟周期就越短，工作速度也就越快。**大多数指令不能在一个时钟周期完成，通常需要若干个时钟周期**。不同的指令需要的时钟周期是不同的，加法和乘法都对应着一条 CPU 指令，但是乘法需要的时钟周期就要比加法多。

 CPU 执行时间 =  CPU 时钟周期数×时钟周期时间

 CPU 时钟周期数 = 指令数 x 每条指令的平均时钟周期数

要想程序跑的更快，优化这三者即可：

1. 指令数，这个层面是基本靠编译器来优化，同样的代码在不同的编译器，编译出来的计算机指令会有各种不同的表示方式。
2. 每条指令的平均时钟周期数 CPI，表示一条指令需要多少个时钟周期数，现代大多数 CPU 通过流水线技术（Pipeline），让一条指令需要的 CPU 时钟周期数尽可能的少；
3. 时钟周期时间，表示计算机主频，取决于计算机硬件。有的 CPU 支持超频技术，打开了超频意味着把 CPU 内部的时钟给调快了，于是 CPU 工作速度就变快了，但是也是有代价的，CPU 跑的越快，散热的压力就会越大，CPU 会很容易崩溃。