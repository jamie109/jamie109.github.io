---
layout: post
title: "[操作系统]进程：消费者-生产者问题"
date: 2023-02-09 15:58 +0800
author: jamie109
categories: [CS_course, OS]
tags: [CS course note, wangdao]
mermaid: true
---
## 题目

![20230209160013](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230209160013.png)

## 思路    
### 同步
在前面学过了使用信号量实现进程的互斥、同步、前驱，前驱可以看作多个同步放一块儿。互斥是说一个临界资源不能同时被两个进程使用，同步是指两个进程的代码有执行的先后顺序。

P、V的加锁与解锁，都是借助“-1”、“+1”来实现的，加锁就给它减去一个（占用资源），解锁就给它加上一个（释放资源）。

信号量也可以用来实现**对一类资源的申请和释放**，它本质上也属于“同步”问题。同步即“一前一后”，对它的处理是前V后P，在执行“后”之前进行加锁，只有“前”执行完了才能解锁。

> 对wait原语（P操作），**是进程p先占下一个资源，** 此时p肯定有一个资源（不管这个资源能不能真的用上），如果此时剩余的资源数小于0，那就说明在p没占资源的时候，资源数小于等于零（小于零是指有别的进程在等它），p肯定是无法用这个资源的，所以要阻塞掉p。  

对生产者而言，缓冲区的数量就是它的锁，在生产者生产产品之前，得看缓冲区数量是不是小于零，如果小于零就不能生产，因为没地儿放，所以要卡住生产者，这个就是P操作做的事情。那什么时候能给它解锁呢？必须要等消费者用掉一个产品后，就有缓冲区空出来了，也就是给它解锁了（V操作）。所以，这里就构成了一个先后关系，**在缓冲区数量为零的情况下**，必须先消费者再生产者。同样，**在产品数量为零的情况下**，必须先生产者再消费者。

>信号量为0，那么肯定是一个在前一个在后（**同步问题**）。资源数大于等于1时，前一段时间两个进程的顺序随意，直到资源用完了，那就必须等一个释放资源，另一个才能执行。也就是这道题目中的“缓冲区数量为零”、“产品数量为零”。

比较简单的思维方式：**P是消耗，如果资源数量为零无法消耗；V是释放，总是把资源数量加一。**

所以，生产者在消耗缓冲区（把产品放入缓冲区）之前，先对缓冲区进行P操作，生产者在释放缓冲区（把产品从缓冲区取出）之后，要对缓冲区进行V操作。消费者使用产品也一样。

```C++
semaphore buffer_num = n; //空闲缓冲区数目 因为一开始都是空的 并且生产者要求缓冲区数目大于0时才能用它
semaphore product_num = 0;//产品数目 一开始为零 
 void producer(){
    生产产品;
    P(buffer_num);
    把产品放到缓冲区;
    v(product_num);
 }
 void consumer(){
    P(product_num);
    把产品从缓冲区拿出来;
    V(buffer_num);
    使用产品;
 }
```
> 这里需要注意，“把产品从缓冲区拿出来”跟“使用产品”是两件事，前者导致缓冲区+1，后者导致产品-1，本题中用到了关于缓冲区、产品的信号量，要把它们分开写。

### 互斥   

互斥就比较简单了，设置一个初值为1的信号量，在生产者/消费者用缓冲区之前P、之后V。完善一下上面的代码：

```C++
semaphore buffer_num = n; //空闲缓冲区数目 因为一开始都是空的 并且生产者要求缓冲区数目大于0时才能用它
semaphore product_num = 0;//产品数目 一开始为零 
semaphore mutex = 1;//互斥信号量
 void producer(){
    生产产品;
    P(buffer_num);
    P(mutex);//互斥信号量
    把产品放到缓冲区;
    V(mutex);//互斥信号量
    v(product_num);
 }
 void consumer(){
    P(product_num);
    P(mutex);//互斥信号量
    把产品从缓冲区拿出来;
    V(mutex);//互斥信号量
    V(buffer_num);
    使用产品;
 }
```

> 答案里还写了一个while循环，应该是让两个进程一直运行的。**互斥P要在同步P之后，V的顺序无所谓**，具体分析见下面答案。

对于PV题目，解决思路分两步：①关系分析，题目中有哪些进程，它们之间有什么同步、互斥关系。②整理思路，根据各进程确定P、V操作的顺序。

1. 两个进程：生产者和消费者。他们不能同时访问缓冲区。（**互斥**）    
2. 生产者，每次运行后缓冲区减少一个、产品增加一个；但需要保证缓存区不满。（**同步**）   
3. 消费者，每次运行后产品减少一个、缓冲区增加一个；但需要保证产品不空。（**同步**）
## 参考答案

我觉得这个命名方式……一个empty一个full，我看的时候就很懵，如果自己写把资源名字写上可能会直观一些。

![20230209160133](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230209160133.png)

![20230209160227](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230209160227.png)

## 总结   
* 互斥信号量初值为1   
* 同步信号量初值为0（要等前操作结束后给它加上一，后操作才能动）  
* 资源的申请和释放，同步信号量初值为资源数目
* 互斥P要在同步P之后，V的顺序无所谓


>[图片来源：B站王道计算机教育](https://www.bilibili.com/video/BV1YE411D7nH?p=8&spm_id_from=pageDriver&vd_source=38881132948112534788036151fc388f)
