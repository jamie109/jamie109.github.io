---
layout: post
title: "《图解HTTP》：HTTP报文"
date: 2023-09-20 21:46 +0800
categories: [CS_course, CN]
tags: [computer network, HTTP]
mermaid: true
math: true
---

HTTP通信过程包括从客户端发往服务器端的请求，及从服务器端返回客户端的响应。

## 1、HTTP报文

### 报文结构

用于HTTP协议交互的信息被称为HTTP报文，HTTP 报文本身是由多行数据构成的字符串文本。

报文大致可分为*报文首部*和*报文主体*两块。两者由最初出现的**空行**来划分。通常，*并不一定要有报文主体*。

- 报文首部：服务器端或客户端需处理的请求或响应的内容及属性。
- 报文主体：应被发送的数据。

![20230920215454](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230920215454.png)

![20230920215552](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230920215552.png)

- *请求行* 包含用于请求的方法，请求 URI 和 HTTP 版本。 
- *状态行* 包含表明响应结果的状态码，原因短语和 HTTP 版本。
- *首部字段* 包含表示请求和响应的各种条件和属性的各类首部。一般有 4 种首部，分别是：通用首部、请求首部、响应首部和实体首部。
- *其他* 可能包含 HTTP 的 RFC 里未定义的首部（Cookie 等）。

## 2、编码提升传输速率

**报文**（message） 是 HTTP 通信中的基本单位，由 8 位组字节流组成，通过HTTP通信传输。

**实体**（entity） 作为请求或响应的有效载荷数据（补充项）被传输，其内容由实体首部和实体主体组成。

HTTP 报文的主体用于传输请求或响应的实体主体，通常，**报文主体等于实体主体**。只有当传输中进行编码操作时，实体主体的内容发生变化，才导致它和报文主体产生差异。

HTTP 在传输数据时可以按照数据原貌直接传输，但也可以在传输过程中通过编码提升传输速率。通过在传输时编码，能有效地处理大量的访问请求。但编码的操作需要计算机来完成，因此会消耗更多的 CPU 等资源。

### 压缩传输的内容编码

内容编码指明应用在实体内容上的**编码格式**，并**保持实体信息原样压缩**。内容编码后的实体由客户端接收并负责解码。（把实体压缩变小后发送）

### 分割发送的分块传输编码

在 HTTP 通信过程中，请求的编码实体资源尚未全部传输完成之前，浏览器无法显示请求页面。**在传输大容量数据时，通过把数据分割成多块，能够让浏览器逐步显示页面**。这种把实体主体分块的功能称为**分块传输编码**。（先将实体主体分割变小后再发送）

分块传输编码会将实体主体分成多个部分（块）。每一块都会用十六进制来*标记块的大小*，而实体主体的*最后一块会使用“0(CR+LF)” 来标记*。使用分块传输编码的实体主体会由接收的客户端负责解码，恢复到编码前的实体主体。

## 3、发送多种数据的多部分对象集合

HTTP 协议中采纳了**多部分对象集合，发送的一份报文主体内可含有多类型实体**（容纳多份不同类型的数据），通常是在图片或文本文件等上传时使用。

在 HTTP 报文中使用多部分对象集合时，需要在首部字段里加上 Content-type，使用 boundary 字符串来划分多部分对象集合指明的各类实体。

在boundary 字符串指定的各个实体的起始行之前插入“--”标记作为开始，而在多部分对象集合对应的字符串的最后插入“--”标记作为结束。

多部分对象集合的每个部分类型中，都可以含有首部字段。

```
Content-Type: multipart/form-data; boundary=AaB03x 

--AaB03x
Content-Disposition: form-data; name="field1"

Joe Blow 
--AaB03x 
Content-Disposition: form-data; name="pics"; filename="file1.txt" 
Content-Type: text/plain

...（file1.txt的数据）... 
--AaB03x--
```


## 4、获取部分内容的范围请求

如果下载过程中遇到网络中断的情况，那就必须重头开始。为了解决上述问题，需要一种**可恢复的机制**。所谓恢复是指能从之前下载中断处恢复下载。要实现该功能**需要指定下载的实体范围**。像这样，指定范围发送的请求叫做范围请求（Range Request）。

执行范围请求时，会用到**首部字段 Range 来指定资源的 byte 范围**。byte 范围的指定形式如下：

```
Range: bytes=5001-10000
Range: bytes=5001-
Range: bytes=-3000, 5000-7000
```

针对范围请求，响应会返回状态码为 **206 Partial Content** 的响应报文。如果服务器端无法响应范围请求，则会返回状态码**200 OK 和完整的实体内容**。

## 5、内容协商返回最合适的内容

**内容协商机制是指客户端和服务器端就响应的资源内容进行交涉，然后提供给客户端最为适合的资源**。内容协商会以响应资源的语言、字符集、编码方式等作为判断的基准。**包含在请求报文中的某些首部字段（如下）就是判断的基准。**

- Accept 
- Accept-Charset 
- Accept-Encoding 
- Accept-Language 
- Content-Language