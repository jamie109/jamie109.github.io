---
layout: post
title: "[操作系统]函数调用VS系统调用"
date: 2023-02-16 18:48 +0800
author: jamie109
categories: [CS_course, OS]
tags: [CS course note]
mermaid: true
math: true
---
## 1.函数调用  
### 栈和栈帧     
![20230216185352](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230216185352.png){: width="600"}   
BP：基址指针寄存器，表示堆栈区域中的**基地址**   
SP：堆栈指针寄存器，指示堆栈区域的**栈顶**地址    
IP：指令指针寄存器，指示要执行指令所在存储单元的地址

栈帧储存的是一个函数在栈中的信息，一般来说相邻的栈帧的关系是父函数与子函数之间的关系，子函数的栈底指针会保存父函数栈底指针的地址。

### 函数调用    
1. 参数入栈: 将参数**从右向左**依次压入系统栈中    
2. 返回地址入栈: 将**当前代码区调用指令的下一条指令地址**压入栈中，供函数返回时继续执行     
3. 代码区跳转: 处理器从当前代码区跳转到被调用函数的入口处      
4. 栈帧调整：保存当前栈帧状态值，已备后面恢复本栈帧时使用(当前栈的基地址BP入栈)，将当前栈帧切换到新栈帧 (将SP值装入BP，更新栈帧底部)，给新栈帧分配空间 (把SP减去所需空间的大小，抬高栈顶)    
![20230216192643](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230216192643.jpg){: width="600"}  

### 函数返回    
1. 保存返回值：将函数的返回值保存在寄存器AX     
2. 弹出当前帧，恢复上一个栈帧：将当前栈帧底部保存的前栈帧BP值弹入BP寄存器，恢复出上一个栈帧，将函数返回地址弹给IP寄存器     
3. 跳转：按照CS:IP跳回调用函数中继续执行

## 2.系统调用   
应用程序通过系统调用请求操作系统的服务。 系统中的各种共享资源都由操作系统统一掌管，因此在用户程序中，凡是与资源有关的操作(如存储分配、I/O操作、文件管理等) ，都必须通过系统调用的方式向操作系统提出服务请求,由操作系统代为完成。这样可以保证系统的稳定性和安全性，防止用户进行非法操作。

![20230216194409](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230216194409.png){: width="600"} 

![20230216194039](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230216194039.png)    
>from chatgpt
>在计算机操作系统中，系统调用是应用程序与操作系统内核之间进行通信的机制之一。当应用程序需要访问**操作系统提供的资源或服务**时，它可以通过系统调用请求操作系统的帮助。下面是一般情况下系统调用的过程：
>1. 应用程序准备参数。应用程序需要准备要传递给系统调用的参数，包括请求的服务类型和所需的数据。这些参数通常需要被放置在指定的寄存器或内存区域中。
>2. 应用程序发起系统调用。应用程序会调用相应的系统调用函数，将参数传递给操作系统内核。
>3. 切换到内核态。当应用程序调用系统调用时，CPU需要从用户态切换到内核态，以便能够执行操作系统内核中的代码。这个过程需要硬件支持，例如操作系统内核必须在内存中被映射到用户态无法访问的内存区域中。
>4. 内核处理系统调用。当操作系统内核收到系统调用时，它会检查请求的服务类型，并根据需要执行相应的操作。这个过程可能涉及到访问系统资源、修改内核数据结构、调度进程等。
>5. 返回结果给应用程序。操作系统内核执行完系统调用之后，它会将结果返回给应用程序。如果系统调用执行成功，那么结果将包含请求的数据；如果出现错误，那么结果将包含错误码。
>6. 切换回用户态。当操作系统内核将结果返回给应用程序时，CPU会从内核态切换回用户态。应用程序可以继续执行其余的代码。    
需要注意的是，系统调用的具体实现可能因操作系统的不同而异，但是上述过程是通用的。系统调用对操作系统内核的性能和安全性具有很高的要求，因此通常需要谨慎设计和实现。

## 3.区别    
* 函数调用发生在用户态的栈，更新CPU寄存器      
* 系统调用发生用户态和内核态切换，更新CPU寄存器     
    1. 系统调用是由OS实现提供的      
    2. 应用程序同系统之间的接口，可以让用户程序使用到仅能够在特权态用到的指令或者数据      
    3. 用户栈到内核栈切换       
    4. 保证系统的稳定性和安全性，防止用户程序随意更改和访问重要的系统资源      
    5. 体现接口模式，OS的具体实现和更新均对用户透明（透明就是用户看不到的意思）   

>from chatgpt 系统调用和函数调用都是计算机程序中常用的两种调用机制，它们的区别和联系如下：     
>**区别**:
系统调用和函数调用的区别在于它们的执行环境不同。系统调用是应用程序与操作系统之间进行通信的一种机制，它通过操作系统提供的接口来访问底层系统资源，例如文件、网络、进程等。系统调用需要切换到内核态，并经过操作系统内核的处理才能执行，因此开销较大。函数调用是应用程序内部的一种机制，它是在用户态下直接执行的，并且不需要切换到内核态，因此开销较小。     
>**联系**:
系统调用和函数调用都是程序中的调用机制。它们的共同点在于都是通过特定的接口来执行某些任务或操作，可以接受参数并返回结果。在实现上，系统调用通常是通过中断机制来实现的，而函数调用则是通过堆栈来实现的。   
此外，函数调用可能会调用一些系统调用来实现某些操作，例如文件读写、网络通信等。在这种情况下，函数调用和系统调用是相互依存的关系。因此，在编写程序时，需要根据具体的需求和场景来选择合适的调用机制


