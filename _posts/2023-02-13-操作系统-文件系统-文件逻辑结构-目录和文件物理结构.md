---
layout: post
title: "[操作系统]文件系统：文件逻辑结构、目录和文件物理结构"
date: 2023-02-13 20:28 +0800
author: jamie109
categories: [CS_course, OS]
tags: [CS course note, wangdao]
mermaid: true
math: true
---
## 1.文件逻辑结构  
### 什么是逻辑结构   
**逻辑结构：在用户看来，文件内部的数据是如何组织起来的**   
物理结构：**操作系统**看来，文件的数据如何存放在外存中的   
```mermaid
graph LR  
文件的逻辑结构-->A(无结构文件)
文件的逻辑结构-->B(有结构文件,重点讨论)
B-->C(顺序文件)
B-->D(索引文件)
B-->E(索引顺序文件)
```
### 无结构文件   
又叫流式文件，比如txt，由一些二进制或者字符流组成。

### 有结构文件  
又叫“记录式文件”，比如数据库表，**由一组相似的记录组成。**
​记录是一组相关数据线的集合，**每条记录有一个数据项可作为关键字**。
根据记录的长度是否相等，分为：**定长记录，可变长记录。**   

### 顺序文件   
![20230213205133](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230213205133.png)   
* 顺序存储+定长记录，可实现随机存取。   
* 顺序存储+定长记录+顺序结构，可快速找到某关键字对应的记录。

![20230213205608](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230213205608.png)

### 索引文件   
**索引表本身是定长记录的顺序文件**，索引表项包含索引号，长度，指针，真正的记录可以在物理上离散存储。

索引号可以是关键字，这样就能折半查找加快检索速度，用于对信息处理及时性要求高的场合，解决了顺序文件增删不便的问题。可以用不同的数据项建立多个索引表​。   
![20230213210159](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230213210159.png)

### 索引顺序文件   
![20230213210531](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230213210531.png)   
1. 将记录分组，每一个组对应一个索引表项    
2. 检索记录时先检索索引表，找到分组，再顺序查找分组    
3. 记录过多时，可以建立多级索引表     
4. 记录N的表，平均查找次数是N/2

* 为进一步提高检索效率，可以为顺序文件建立多级索引表。
### 总结   
![20230213210909](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230213210909.png)

## 2.文件目录   
### 文件控制块FCB   
目录本身就是一种有结构文件，由一条条记录组成。每条记录对应一个在该放在该目录下的文件。文件目录的类型就是“目录”，就像txt文件的类型是txt。

一个FCB对应一个文件，一个FCB就是一个**目录项**，**FCB的有序集合叫“文件目录”**。FCB包含了文件的基本信息，存取控制信息，使用信息等等，**最重要、最基本的是文件名、文件存放的物理地址**。

对目录的操作:搜索文件、创建文件、删除文件、显示目录、修改目录。

### 单级目录结构   
早期OS不支持多级目录，整个系统中只建立一张目录表，每个文件占一个目录项。   
![20230213215928](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230213215928.png)   
### 两级目录结构   
![20230213220101](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230213220101.png)

### 多级(树形)目录结构   
* 绝对路径和相对路径   
* 根目录和当前目录

![20230213220314](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230213220314.png)   
![20230213220413](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230213220413.png)  
**树形结构不便于文件的共享**。

### 无环图目录结构   
![20230213222402](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230213222402.png)

### 索引节点（FCB的优化）   
在查找目录各级目录的过程中，只需要用到“文件名”，只有文件名匹配时，才需要读出文件的其他信息。所以可以对**目录表进行瘦身**。   
>一个FCB对应一个文件，一个FCB就是一个**目录项**    
索引节点，除了文件名之外的描述信息。   

![20230213222807](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230213222807.png)
>目录表变小了，要找的磁盘块变少了，IO操作时间减少，更快了。

## 3.文件物理结构（文件分配方式）   
文件数据应该怎样存放在外存中？    
```mermaid
graph LR
文件物理结构-->A(连续分配)
文件物理结构-->B(链接分配)
B-->C(隐式链接)
B-->D(显式链接)
文件物理结构-->E(索引分配)

```

* 类似内存分页，磁盘中的存储单元也会被分成一个个“块/磁盘块/物理块”。一般**磁盘块和内存块、页面的大小相同。**（PS复习一下，进程时页面，内存是页框）内存与磁盘中的数据交换是以块为单位的。

![20230214101346](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230214101346.png)   

### 连续分配   
**每个文件在磁盘上占有一组连续的块。**
顺序访问：如果我要访问逻辑块号2，那么我必须先顺序地访问逻辑块号0和1。    
随机访问（直接访问）：如果我要访问逻辑块号2，那么我可以直接找到逻辑块号2，不需要先访问0和1。

![20230214102345](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230214102345.png)   
**读取某个文件时，需要移动磁头**。访问的两个磁盘块离得越远，移动磁头时间越长。   
**连续分配，顺序访问时速度最快（移动磁头所需的时间短）**   
缺点：**不方便文件扩展**（比如文件A想要增加一个磁盘块），每次扩展都得迁移到一段连续的空间，代价大；存储空间利用率低，产生磁盘碎片（只有空着的单个磁盘块，但我这个文件需要三个磁盘块，总的磁盘块数目够，但由于连续分配无法存储该文件）。

### 链接分配    
**采取离散分配的方式，分隐式、显示两种。**  
**题目中默认隐式链接**   
#### 隐式分配   
![20230214103526](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230214103526.png)  
**方便拓展文件，不会有碎片问题，外存利用率高。缺点：不支持随机访问，查找效率低。** 

#### 显式分配   
**逻辑块号转物理块号不需要访问磁盘，因此支持随机访问；扩展方便且不会有磁盘碎片。缺点是FAT要占用一定的存储空间。**

![20230214103926](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230214103926.png)   
![20230214104437](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230214104437.png)   
>一个文件有一个文件控制块FCB，里面记录。一个磁盘有一个文件分配表FAT。    
>先从FCB中找到这个文件的起始块号（磁盘中的块号），然后逻辑块号相当于偏移量，物理块号=起始块号+逻辑块号。   

### 索引分配   
文件离散地放在各个磁盘块中，**每一个文件建立一张索引表，其中记录文件的逻辑块对应的物理块**。存放索引表的磁盘块叫索引块，存放文件数据的磁盘块叫数据块。   
![20230214110228](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230214110228.png)    
>给出要访问文件的逻辑块号，先找到FCB，找到索引表在磁盘中的存放位置    
>把索引表读入内存，查找索引表找到该逻辑块号对应的物理块号   

**索引分配支持随机访问，文件拓展容易实现。**    

#### 一个磁盘块装不下文件整张索引表    
>套娃开始啦

1. 链接方案    
    ![20230214111115](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230214111115.png)    
    如果要找文件的最后一个逻辑块，就得遍历所有索引块，一直到最后。    
2. 多层索引    
   ![20230214111548](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230214111548.png)   
3. 混合索引   
   ![20230214111849](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230214111849.png)
### 对比   
![20230214112118](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230214112118.png)    
![20230214112134](https://cdn.jsdelivr.net/gh/jamie109/my-img/for-VSCode/20230214112134.png)

> thanks for [B站王道计算机教育](https://www.bilibili.com/video/BV1YE411D7nH?p=8&spm_id_from=pageDriver&vd_source=38881132948112534788036151fc388f)
